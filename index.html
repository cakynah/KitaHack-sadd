<!DOCTYPE html>
<html lang="ms">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#7C42D1" />
  <meta name="description" content="BelajarKu - Aplikasi Pembelajaran untuk Murid Sekolah Rendah" />
  <title>BelajarKu ğŸŒŸ</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="index.css" />
</head>

<body>

  <!-- ========== SPLASH SCREEN ========== -->
  <div id="screen-splash" class="screen active">
    <div class="splash-blob blob1"></div>
    <div class="splash-blob blob2"></div>

    <div class="splash-mascot">ğŸ¦</div>
    <div class="splash-title">Belajar<span>Ku</span></div>
    <div class="splash-subtitle" data-bm="Pembelajaran seronok berteraskan AI, dimana sahaja! ğŸŒŸ"
      data-bi="AI integrated fun learning, wherever you are! ğŸŒŸ">
      Pembelajaran seronok berteraskan AI, dimana sahaja! ğŸŒŸ</div>

    <button class="btn-primary" onclick="goToHome()" aria-label="Mula Belajar Sekarang">
      <span data-bm="ğŸš€ Mula Belajar Sekarang!" data-bi="ğŸš€ Start Learning Now!">ğŸš€ Mula Belajar Sekarang!</span>
    </button>

    <div class="stars-row">
      <span class="star">â­</span>
      <span class="star">ğŸŒŸ</span>
      <span class="star">â­</span>
    </div>
  </div>


  <!-- ========== HOME SCREEN ========== -->
  <div id="screen-home" class="screen">
    <!-- Top Bar -->
    <div class="topbar">
      <div class="topbar-logo">ğŸ¦ BelajarKu</div>
      <div class="lang-toggle">
        <button class="lang-btn active" id="lang-bm" onclick="setLang('bm')">BM</button>
        <button class="lang-btn" id="lang-bi" onclick="setLang('bi')">BI</button>
      </div>
    </div>

    <!-- Header -->
    <div class="home-header">
      <div class="greeting" data-bm="Selamat Datang, Pelajar Hebat!" data-bi="Welcome, Amazing Student!">Selamat Datang,
        Pelajar Hebat!</div>
      <div class="greeting-name" data-bm="Apa khabar hari ini? ğŸ˜Š" data-bi="How are you today? ğŸ˜Š">Apa khabar hari ini?
        ğŸ˜Š</div>

      <!-- Marks Progress Card -->
      <div class="user-marks-card">
        <div class="marks-header">
          <div class="marks-title">
            <span class="marks-icon">â­</span>
            <span id="home-score-text">0 mata</span>
          </div>
          <div class="marks-rank" id="home-rank-text">Pelajar Baru</div>
        </div>
        <div class="marks-bar-track">
          <div class="marks-bar-fill" id="home-score-bar" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- PWA Status Bar -->
    <div class="status-bar">
      <div class="offline-badge">
        <div class="offline-icon">ğŸ“¶</div>
        <div>
          <div class="offline-text" data-bm="âœ… Sedia untuk Belajar Luar Talian" data-bi="âœ… Ready for Offline Learning">âœ…
            Sedia untuk Belajar Luar Talian</div>
          <div class="offline-sub" id="sync-status" data-bm="Kandungan terkini disimpan" data-bi="Latest content saved">
            Kandungan terkini disimpan</div>
        </div>
      </div>
      <div class="status-dot" id="status-dot" title="Online"></div>
    </div>

    <!-- 3 Big Action Buttons -->

    <!-- 3 Big Action Buttons -->
    <div class="actions-grid">
      <button class="action-btn btn-belajar" onclick="showScreen('screen-subjects')">
        <span class="btn-sparkle">âœ¨</span>
        <div class="btn-icon">ğŸ“–</div>
        <div class="btn-title" data-bm="Mula Belajar" data-bi="Start Learning">Mula Belajar</div>
        <div class="btn-sub" data-bm="Pilih subjek anda" data-bi="Choose your subject">Pilih subjek anda</div>
      </button>

      <button class="action-btn btn-tanya" onclick="showScreen('screen-chat')">
        <div class="btn-icon">ğŸ¤–</div>
        <div class="btn-title" data-bm="Tanya Cikgu AI" data-bi="Ask AI Teacher">Tanya Cikgu AI</div>
        <div class="btn-sub" data-bm="Tanya apa sahaja!" data-bi="Ask anything!">Tanya apa sahaja!</div>
      </button>

      <button class="action-btn btn-cabaran" onclick="showScreen('screen-quiz')">
        <span class="btn-sparkle" style="font-size:14px">ğŸŒŸ</span>
        <div class="btn-icon">ğŸ®</div>
        <div class="btn-title" data-bm="Cabaran Saya" data-bi="My Challenge">Cabaran Saya</div>
        <div class="btn-sub" data-bm="Kuiz & permainan interaktif menyeronokkan!"
          data-bi="Fun interactive quizzes & games!"> Kuiz & permainan interaktif menyeronokkan!</div>
      </button>
    </div>

    <!-- Favourites Section -->
    <div class="favourites-section" id="favourites-section" style="display:none">
      <div class="fav-title" data-bm="â­ Kegemaran Saya" data-bi="â­ My Favourites">â­ Kegemaran Saya</div>
      <div class="fav-list" id="fav-list"></div>
    </div>

    <div class="scroll-hint" data-bm="â¬† Tatal ke atas untuk lebih banyak" data-bi="â¬† Scroll up for more">â¬† Tatal ke atas
      untuk lebih banyak</div>
  </div>


  <!-- ========== SUBJECTS SCREEN ========== -->
  <div id="screen-subjects" class="screen">
    <div class="topbar">
      <div class="topbar-logo">ğŸ¦ BelajarKu</div>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('bm')">BM</button>
        <button class="lang-btn" onclick="setLang('bi')">BI</button>
      </div>
    </div>

    <div class="screen-header">
      <button class="back-btn" onclick="showScreen('screen-home')" aria-label="Kembali ke Utama">â†</button>
      <div class="screen-title" data-bm="ğŸ“– Pilih Subjek" data-bi="ğŸ“– Choose Subject">ğŸ“– Pilih Subjek</div>
      <div class="screen-subtitle" data-bm="Apa yang anda nak belajar hari ini?"
        data-bi="What do you want to learn today?">Apa yang anda nak belajar hari ini?</div>
    </div>

    <div class="subjects-grid">
      <div class="subject-card bm" onclick="chooseSubject('bm')">
        <div class="subject-icon">ğŸ‡²ğŸ‡¾</div>
        <div class="subject-name" data-bm="Bahasa Melayu" data-bi="Bahasa Melayu">Bahasa Melayu</div>
        <div class="subject-level" data-bm="Tahap 1 â€¢ 8 Modul" data-bi="Level 1 â€¢ 8 Modules"></div>
      </div>

      <div class="subject-card bi" onclick="chooseSubject('bi')">
        <div class="subject-icon">ğŸ‡¬ğŸ‡§</div>
        <div class="subject-name">English</div>
        <div class="subject-level" data-bm="Tahap 1 â€¢ 8 Modul" data-bi="Level 1 â€¢ 8 Modules"></div>
      </div>

      <div class="subject-card math" onclick="chooseSubject('math')">
        <div class="subject-icon">ğŸ”¢</div>
        <div class="subject-name" data-bm="Matematik" data-bi="Mathematics">Matematik</div>
        <div class="subject-level" data-bm="Tahap 1 â€¢ 10 Modul" data-bi="Level 1 â€¢ 10 Modules"></div>
      </div>

      <div class="subject-card science" onclick="chooseSubject('science')">
        <div class="subject-icon">ğŸ”¬</div>
        <div class="subject-name" data-bm="Sains" data-bi="Science">Sains</div>
        <div class="subject-level" data-bm="Tahap 1 â€¢ 6 Modul" data-bi="Level 1 â€¢ 6 Modules"></div>
      </div>
    </div>
    </div>
  </div>


  <!-- ========== STANDARDS SCREEN (NEW) ========== -->
  <div id="screen-standards" class="screen">
    <div class="topbar">
      <div class="topbar-logo">ğŸ¦ BelajarKu</div>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('bm')">BM</button>
        <button class="lang-btn" onclick="setLang('bi')">BI</button>
      </div>
    </div>

    <div class="screen-header">
      <button class="back-btn" onclick="showScreen('screen-subjects')" aria-label="Kembali ke Subjek">â†</button>
      <div class="screen-title" data-bm="ğŸ« Pilih Tahun" data-bi="ğŸ« Choose Standard">ğŸ« Pilih Tahun</div>
      <div class="screen-subtitle" data-bm="Pilih tahap pembelajaran kamu" data-bi="Select your learning level">Pilih
        tahap pembelajaran kamu</div>
    </div>

    <div class="subjects-grid">
      <button class="subject-card bm" onclick="chooseStandard(1)">
        <div class="subject-icon">1ï¸âƒ£</div>
        <div class="subject-name" data-bm="Tahun 1" data-bi="Standard 1">Tahun 1</div>
      </button>
      <button class="subject-card bi" onclick="chooseStandard(2)">
        <div class="subject-icon">2ï¸âƒ£</div>
        <div class="subject-name" data-bm="Tahun 2" data-bi="Standard 2">Tahun 2</div>
      </button>
      <button class="subject-card math" onclick="chooseStandard(3)">
        <div class="subject-icon">3ï¸âƒ£</div>
        <div class="subject-name" data-bm="Tahun 3" data-bi="Standard 3">Tahun 3</div>
      </button>
    </div>
  </div>


  <!-- ========== LESSONS SCREEN ========== -->

  <div id="screen-lessons" class="screen">
    <div class="topbar">
      <div class="topbar-logo">ğŸ¦ BelajarKu</div>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('bm')">BM</button>
        <button class="lang-btn" onclick="setLang('bi')">BI</button>
      </div>
    </div>

    <div class="screen-header">
      <button class="back-btn" onclick="showScreen('screen-standards')" aria-label="Kembali ke Tahun">â†</button>
      <div class="screen-title" id="lessons-title">ğŸ“š Bahasa Melayu</div>
      <div class="screen-subtitle" data-bm="Kad Belajar Mini â€” Tatal ke bawah!"
        data-bi="Mini Learning Cards â€” Scroll down!">Kad Belajar Mini â€” Tatal ke bawah!</div>
    </div>

    <div class="lessons-scroll" id="lessons-container">
      <!-- Cards injected by JS -->
    </div>
  </div>


  <!-- ========== LESSON CONTENT SCREEN ========== -->
  <div id="screen-lesson-content" class="screen">
    <div class="topbar">
      <div class="topbar-logo">ğŸ¦ BelajarKu</div>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('bm')">BM</button>
        <button class="lang-btn" onclick="setLang('bi')">BI</button>
      </div>
    </div>

    <div class="screen-header">
      <button class="back-btn" id="lesson-content-back">â†</button>
      <div class="screen-title" id="lesson-content-title">Tajuk Pelajaran</div>
      <div class="screen-subtitle" id="lesson-content-subtitle">Modul 1</div>
    </div>

    <div class="lesson-view-container" style="padding: 20px; overflow-y: auto;">
      <div class="lesson-content-card"
        style="background: white; border-radius: 20px; padding: 24px; box-shadow: var(--card-shadow);">
        <div id="lesson-visual" style="font-size: 80px; text-align: center; margin-bottom: 20px;">ğŸ“–</div>
        <div id="lesson-text" style="font-size: 16px; line-height: 1.6; color: #333; font-weight: 600;">
          <!-- Content injected by JS -->
        </div>
      </div>

      <div style="margin-top: 24px; text-align: center;">
        <button class="btn-primary" id="lesson-complete-btn" style="width: 100%;">
          <span data-bm="âœ… Selesai Belajar!" data-bi="âœ… Done Learning!">âœ… Selesai Belajar!</span>
        </button>
      </div>
    </div>
  </div>





  <!-- ========== QUIZ SCREEN ========== -->
  <div id="screen-quiz" class="screen">
    <div class="topbar">
      <div class="topbar-logo">ğŸ¦ BelajarKu</div>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('bm')">BM</button>
        <button class="lang-btn" onclick="setLang('bi')">BI</button>
      </div>
    </div>

    <div class="screen-header">
      <button class="back-btn" onclick="showScreen('screen-home')" aria-label="Kembali ke Utama">â†</button>
      <div class="screen-title" data-bm="ğŸ® Cabaran Saya" data-bi="ğŸ® My Challenge">ğŸ® Cabaran Saya</div>
      <div class="screen-subtitle" data-bm="Jawab & kumpul bintang! â­" data-bi="Answer & collect stars! â­">Jawab &
        kumpul bintang! â­</div>
    </div>

    <!-- Cikgu Leo Mascot Below Quiz -->
    <div class="mascot-container"
      style="display: flex; align-items: center; gap: 12px; margin: 0 20px 16px; background: white; padding: 12px 16px; border-radius: 20px; box-shadow: var(--card-shadow);">
      <div
        style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--purple), var(--blue)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
        ğŸ¦</div>
      <div style="font-size: 14px; font-weight: 700; color: var(--purple-dark); line-height: 1.4;" id="quiz-mascot-msg"
        data-bm="Hai kawan pintar! Mari kita jawab cabaran ini bersama-sama. Kamu pasti boleh! ğŸ˜Š"
        data-bi="Hi smart friend! Let's answer this challenge together. You can do it! ğŸ˜Š">Hai kawan pintar! Mari kita
        jawab cabaran ini bersama-sama. Kamu pasti boleh! ğŸ˜Š</div>
    </div>

    <div class="quiz-card">
      <div class="quiz-meta">
        <div class="quiz-no" id="quiz-no">Soalan 1 / 4</div>
        <div class="quiz-score-badge" id="quiz-score">â­ 0 mata</div>
      </div>
      <div class="quiz-progress-track">
        <div class="quiz-progress-fill" id="quiz-progress" style="width:25%"></div>
      </div>
      <div class="quiz-question-img" id="quiz-img">ğŸ</div>
      <div class="quiz-question" id="quiz-question">Apakah nama buah ini dalam Bahasa Melayu?</div>
      <div class="quiz-options" id="quiz-options">
        <!-- Injected by JS -->
      </div>
      <div class="quiz-feedback" id="quiz-feedback"></div>
    </div>

    <div class="quiz-nav">
      <button class="btn-next" id="btn-next" onclick="nextQuestion()">
        <span data-bm="Soalan Seterusnya âœ" data-bi="Next Question âœ">Soalan Seterusnya âœ</span>
      </button>
    </div>


  </div>

  <!-- ========== CHAT SCREEN ========== -->
  <div id="screen-chat" class="screen">
    <div class="topbar">
      <div class="topbar-logo">ğŸ¦ BelajarKu</div>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('bm')">BM</button>
        <button class="lang-btn" onclick="setLang('bi')">BI</button>
      </div>
    </div>

    <div class="screen-header">
      <button class="back-btn" onclick="showScreen('screen-home')" aria-label="Kembali ke Utama">â†</button>
      <div class="screen-title" data-bm="ğŸ¤– Tanya Cikgu AI" data-bi="ğŸ¤– Ask AI Teacher">ğŸ¤– Tanya Cikgu AI</div>
      <div class="screen-subtitle" data-bm="Saya sedia bantu kamu belajar!" data-bi="I'm ready to help you learn!">Saya
        sedia bantu kamu belajar!</div>
    </div>

    <!-- Quick Questions -->
    <div class="quick-questions" id="quick-questions">
      <button class="quick-q" onclick="askQuestion(this.textContent)">Apa itu ayat?</button>
      <button class="quick-q" onclick="askQuestion(this.textContent)">Tolong ajar matematik</button>
      <button class="quick-q" onclick="askQuestion(this.textContent)">Apa itu fotosintesis?</button>
      <button class="quick-q" onclick="askQuestion(this.textContent)">Cerita tentang Malaysia</button>
    </div>

    <div class="chat-messages" id="chat-messages">
      <div class="bubble-row">
        <div class="ai-avatar">ğŸ¦</div>
        <div class="chat-bubble bubble-ai">
          <div class="bubble-sender">Cikgu Leo ğŸ¦</div>
          <span data-bm="Helo! Saya Cikgu Leo ğŸ‰ Tanya saya apa sahaja tentang pelajaran kamu. Saya suka membantu! ğŸ“š"
            data-bi="Hello! I'm Teacher Leo ğŸ‰ Ask me anything about your lessons. I love to help! ğŸ“š">Helo! Saya Cikgu
            Leo ğŸ‰ Tanya saya apa sahaja tentang pelajaran kamu. Saya suka membantu! ğŸ“š</span>
        </div>
      </div>
    </div>

    <div class="chat-input-bar">
      <textarea class="chat-input" id="chat-input" rows="1" placeholder="Taip soalan kamu di sini..."
        onkeydown="handleChatKey(event)" aria-label="Taip soalan chat"></textarea>
      <button class="send-btn" onclick="sendChat()" aria-label="Hantar mesej">â¤</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- ========== DATA (OFFLINE COMPATIBLE) ========== -->
  <script src="data.js"></script>

  <!-- ========== FIREBASE SDK & JS ========== -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
    import { initializeFirestore, persistentLocalCache, persistentMultipleTabManager, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    try {
      // Access data from data.js global script
      const { quizData, lessonsData, aiResponses } = window;
      
      if (!quizData) {
        console.error('âŒ data.js did not load properly. Check browser console.');
        throw new Error('data.js failed to load');
      }

    // Global variable to store chat history for Gemini
    let geminiChatHistory = [
      {
        role: "user",
        parts: [{ text: "You are Cikgu Leo, a friendly and encouraging Malaysian teacher. Use a mix of Bahasa Melayu and English (Manglish). Your goal is to help students learn. Always ask them one question at a time to test their knowledge, wait for their answer, provide feedback, and then ask the next question." }]
      },
      {
        role: "model",
        parts: [{ text: "Hebat! Saya Cikgu Leo ğŸ¦. Jom kita mula belajar! Adakah kamu sudah sedia untuk soalan pertama?" }]
      }
    ];

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDNNsUsVgdnKAl0WLExFxXonb9Ncuy7Zuc",
      authDomain: "belajarku-aa2ac.firebaseapp.com",
      projectId: "belajarku-aa2ac",
      storageBucket: "belajarku-aa2ac.firebasestorage.app",
      messagingSenderId: "362005096892",
      appId: "1:362005096892:web:db00fb3b3388c2472d23b9",
      measurementId: "G-40X994V29X"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    // Modern Firestore Initialization
    const db = initializeFirestore(app, {
      localCache: persistentLocalCache({
        tabManager: persistentMultipleTabManager()
      })
    });
    const auth = getAuth(app);

    console.log('BelajarKu Script Loading (Firebase Active)...');

    // Detect localhost for development mode
    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    if (isLocalhost) {
      console.log('ğŸ”§ Development mode detected (localhost). Using localStorage with Firebase fallback.');
    }

    // ======== STATE ========
    let userId = null;
    let currentLang = 'bm';
    let currentScore = 0; // Persistent account score
    let quizSessionScore = 0; // Score for current quiz session only
    let currentQ = 0;
    let answered = false;
    let selectedSubject = '';
    let selectedStandard = '';
    let savedLessons = []; // In-memory array: [{title, std, subject, index}]
    let currentLessonInfo = null; // Stores {std, subject, index} for current lesson being viewed
    const GEMINI_API_KEY = 'AIzaSyD3aFUMgxo0HGkdY0APNMgeZWFxeRiKtc0';

    // Auth & Persistence Logic
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        loadProgress();
      } else {
        signInAnonymously(auth).catch((err) => {
          console.warn("Auth failed (localhost may not be authorized in Firebase):", err);
          // Still load from localStorage on localhost
          loadProgress();
        });
      }
    });

    // ======== NAVIGATION ========
    // ======== SYNC LOGIC (FIREBASE) ========
    async function saveProgress() {
      localStorage.setItem('belajarku_score', currentScore);
      localStorage.setItem('belajarku_saved_lessons', JSON.stringify(savedLessons));

      // Skip Firebase on localhost if auth failed
      if (!userId || isLocalhost) {
        console.log('ğŸ“± Progress saved to localStorage');
        return;
      }

      try {
        await setDoc(doc(db, "userProfiles", userId), {
          score: currentScore,
          savedLessons: savedLessons,
          lastUpdated: new Date()
        }, { merge: true });
        console.log("Progress saved to Firestore");
      } catch (e) {
        console.warn("Failed to save to Firestore, using local fallback", e);
      }
    }

    async function loadProgress() {
      // Load from localStorage first (instant)
      const localScore = localStorage.getItem('belajarku_score');
      const localSaved = JSON.parse(localStorage.getItem('belajarku_saved_lessons') || '[]');
      if (localScore !== null) currentScore = parseInt(localScore);
      savedLessons = localSaved;

      // Skip Firestore on localhost if no userId
      if (!userId || isLocalhost) {
        console.log('ğŸ“± Progress loaded from localStorage');
        document.getElementById('quiz-score').textContent = `â­ ${currentScore} ${currentLang === 'bm' ? 'mata' : 'pts'}`;
        updateHomeMarks();
        renderFavourites();
        return;
      }

      if (userId) {
        try {
          const userDoc = await getDoc(doc(db, "userProfiles", userId));
          if (userDoc.exists()) {
            const data = userDoc.data();
            currentScore = data.score || currentScore;
            if (data.savedLessons && data.savedLessons.length > 0) {
              savedLessons = data.savedLessons;
              localStorage.setItem('belajarku_saved_lessons', JSON.stringify(savedLessons));
            }
            console.log("Progress loaded from Firestore");
          }
        } catch (e) {
          console.warn("Firestore load failed, using local", e);
        }
      }

      document.getElementById('quiz-score').textContent = `â­ ${currentScore} ${currentLang === 'bm' ? 'mata' : 'pts'}`;
      updateHomeMarks();
      renderFavourites();
    }

    function updateHomeMarks() {
      const scoreTxt = document.getElementById('home-score-text');
      const rankTxt = document.getElementById('home-rank-text');
      const barFill = document.getElementById('home-score-bar');

      if (!scoreTxt || !rankTxt || !barFill) return;

      scoreTxt.textContent = `${currentScore} ${currentLang === 'bm' ? 'mata' : 'pts'}`;

      // Rank Logic
      let rank = 'Pelajar Baru';
      let rankBi = 'New Learner';
      let maxForBar = 100;

      if (currentScore >= 500) {
        rank = 'Adiwira Bijak';
        rankBi = 'Smart Superhero';
        maxForBar = 1000;
      } else if (currentScore >= 200) {
        rank = 'Johan Belajar';
        rankBi = 'Learning Champion';
        maxForBar = 500;
      } else if (currentScore >= 50) {
        rank = 'Bintang Harapan';
        rankBi = 'Rising Star';
        maxForBar = 200;
      }

      rankTxt.textContent = currentLang === 'bm' ? rank : rankBi;

      const pct = Math.min((currentScore / maxForBar) * 100, 100);
      barFill.style.width = `${pct}%`;
    }

    async function fetchLessons(std, subject) {
      // Local Fallback Data
      const fallback = lessonsData[std]?.[subject];

      if (!db || !userId) return fallback;

      try {
        const lessonRef = doc(db, "lessons", `${std}_${subject}`);
        const lessonSnap = await getDoc(lessonRef);
        if (lessonSnap.exists()) {
          console.log("Lessons loaded from Firestore!");
          return lessonSnap.data();
        }
      } catch (e) {
        console.warn("Firestore lessons fetch failed", e);
      }
      return fallback;
    }

    // Helper function to get translated text
    function getLangText(field) {
      if (typeof field === 'object' && field !== null) {
        return field[currentLang] || field['bm'] || '';
      }
      return field || '';
    }

    // ======== NAVIGATION ========
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const target = document.getElementById(id);
      if (target) target.classList.add('active');
      window.scrollTo(0, 0);
    }

    function goToHome() {
      console.log("Going home...");
      showScreen('screen-home');
      initQuiz();
      loadProgress();
    }

    function chooseSubject(subject) {
      selectedSubject = subject;
      showScreen('screen-standards');
    }

    function chooseStandard(std) {
      selectedStandard = `std${std}`;
      showLessons();
    }

    async function showLessons() {
      const data = await fetchLessons(selectedStandard, selectedSubject);
      if (!data) return;

      document.getElementById('lessons-title').textContent = getLangText(data.title);
      const container = document.getElementById('lessons-container');
      container.innerHTML = '';

      data.cards.forEach((card, i) => {
        const isSaved = savedLessons.some(s => s.title === card.title && s.std === selectedStandard && s.subject === selectedSubject);
        container.innerHTML += `
          <div class="lesson-card ${i === 0 ? 'active' : ''}" onclick="openLesson('${selectedStandard}', '${selectedSubject}', ${i})">
            <div class="lesson-card-img ${card.bg}">${card.emoji}</div>
            <div class="lesson-card-body">
              <div class="lesson-tag">${getLangText(card.tag)}</div>
              <div class="lesson-title">${getLangText(card.title)}</div>
              <div class="lesson-desc">${getLangText(card.desc)}</div>
            </div>
            <div class="lesson-footer">
              <div class="lesson-meta">
                <span>â± ${card.time}</span>
                <span>ğŸ“Š ${getLangText(card.level)}</span>
              </div>
              <button class="save-btn ${isSaved ? 'saved' : ''}" data-std="${selectedStandard}" data-subject="${selectedSubject}" data-index="${i}" onclick="event.stopPropagation(); saveLesson(this)" aria-label="Simpan ke kegemaran">
                ${isSaved ? 'â­ <span data-bm="Kegemaran!" data-bi="Favourited!">Kegemaran!</span>' : 'â˜† <span data-bm="Tambah Kegemaran" data-bi="Add to Favourites">Tambah Kegemaran</span>'}
              </button>
            </div>
          </div>
        `;
      });

      showScreen('screen-lessons');
      setLang(currentLang); // Re-apply language labels
    }

    function openLesson(std, subject, index) {
      const card = lessonsData[std][subject].cards[index];
      // Store current lesson info for language toggle
      currentLessonInfo = {std, subject, index};
      document.getElementById('lesson-content-title').textContent = getLangText(card.title);
      document.getElementById('lesson-content-subtitle').textContent = getLangText(card.tag);
      document.getElementById('lesson-visual').textContent = card.emoji;
      document.getElementById('lesson-text').innerHTML = currentLang === 'bm' ? card.content : card.content_bi;

      document.getElementById('lesson-content-back').onclick = () => {
        currentLessonInfo = null;
        showLessons();
      };
      document.getElementById('lesson-complete-btn').onclick = () => {
        showToast(currentLang === 'bm' ? 'ğŸŒŸ Syabas! Pelajaran selesai!' : 'ğŸŒŸ Well done! Lesson complete!');
        currentLessonInfo = null;
        showLessons();
      };

      showScreen('screen-lesson-content');
    }

    function saveLesson(btn) {
      btn.classList.toggle('saved');
      const saved = btn.classList.contains('saved');
      const std = btn.getAttribute('data-std');
      const subject = btn.getAttribute('data-subject');
      const index = parseInt(btn.getAttribute('data-index'));
      // compute title from lessonsData to avoid storing object/string confusion
      let title = '';
      try {
        const card = lessonsData[std][subject].cards[index];
        title = getLangText(card.title);
      } catch (e) {
        // fallback to blank
        title = '';
      }

      if (saved) {
        // Add to in-memory array if not already there (compare by std/subject/index)
        const exists = savedLessons.some(s => s.std === std && s.subject === subject && s.index === index);
        if (!exists) savedLessons.push({ std, subject, index });
        btn.innerHTML = `â­ <span data-bm="Kegemaran!" data-bi="Favourited!">Kegemaran!</span>`;
        setLang(currentLang);
        showToast(currentLang === 'bm' ? `â­ "${title}" ditambah ke Kegemaran!` : `â­ "${title}" added to Favourites!`);
      } else {
        // Remove from in-memory array
        savedLessons = savedLessons.filter(s => !(s.std === std && s.subject === subject && s.index === index));
        btn.innerHTML = `â˜† <span data-bm="Tambah Kegemaran" data-bi="Add to Favourites">Tambah Kegemaran</span>`;
        setLang(currentLang);
        showToast(currentLang === 'bm' ? `ğŸ—‘ï¸ "${title}" dibuang dari Kegemaran.` : `ğŸ—‘ï¸ "${title}" removed from Favourites.`);
      }
      saveProgress();
      renderFavourites();
    }

    function renderFavourites() {
      const section = document.getElementById('favourites-section');
      const list = document.getElementById('fav-list');
      if (!section || !list) return;

      if (savedLessons.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      list.innerHTML = savedLessons.map(item => {
        // item contains {std,subject,index}
        let titleText = '';
        try {
          const card = lessonsData[item.std][item.subject].cards[item.index];
          titleText = getLangText(card.title);
        } catch {
          titleText = '';
        }
        const navAttr = `onclick="goToFavLesson('${item.std}','${item.subject}',${item.index})"`;
        return `
          <div class="fav-chip" ${navAttr}>
            <span class="fav-chip-star">â­</span>
            <span class="fav-chip-title">${titleText}</span>
          </div>
        `;
      }).join('');
    }

    function goToFavLesson(std, subject, index) {
      selectedStandard = std;
      selectedSubject = subject;
      showLessons().then(() => {
        openLesson(std, subject, index);
      });
    }

    // ======== LANGUAGE ========
    function setLang(lang) {
      currentLang = lang;
      document.querySelectorAll('[data-bm]').forEach(el => {
        if (el.dataset[lang]) el.textContent = el.dataset[lang];
      });
      document.querySelectorAll('.lang-btn').forEach(btn => {
        const isActive = btn.getAttribute('onclick')?.includes(`'${lang}'`);
        btn.classList.toggle('active', !!isActive);
      });
      const mascotMsg = document.getElementById('quiz-mascot-msg');
      if (mascotMsg) mascotMsg.textContent = mascotMsg.dataset[lang];
      
      // Update lesson list if currently viewing lessons
      const lessonsContainer = document.getElementById('lessons-container');
      if (lessonsContainer && lessonsContainer.children.length > 0) {
        const lessonsTitle = document.getElementById('lessons-title');
        const data = lessonsData[selectedStandard]?.[selectedSubject];
        if (data) {
          lessonsTitle.textContent = getLangText(data.title);
          // Update all lesson cards
          document.querySelectorAll('.lesson-tag').forEach((tagEl, idx) => {
            const card = data.cards[idx];
            if (card) {
              tagEl.textContent = getLangText(card.tag);
              tagEl.nextElementSibling.textContent = getLangText(card.title);
              tagEl.nextElementSibling.nextElementSibling.textContent = getLangText(card.desc);
            }
          });
          // Update level in lesson footer
          document.querySelectorAll('.lesson-meta').forEach((metaEl, idx) => {
            const card = data.cards[idx];
            if (card) {
              const spans = metaEl.querySelectorAll('span');
              if (spans[1]) spans[1].textContent = `ğŸ“Š ${getLangText(card.level)}`;
            }
          });
        }
      }
      
      // Update lesson content if currently viewing a lesson
      if (currentLessonInfo) {
        const {std, subject, index} = currentLessonInfo;
        const card = lessonsData[std][subject].cards[index];
        document.getElementById('lesson-content-title').textContent = getLangText(card.title);
        document.getElementById('lesson-content-subtitle').textContent = getLangText(card.tag);
        document.getElementById('lesson-text').innerHTML = lang === 'bm' ? card.content : card.content_bi;
      }

      const qs = document.getElementById('quick-questions');
      if (qs) {
        if (lang === 'bm') {
          qs.innerHTML = `
            <button class="quick-q" onclick="askQuestion(this.textContent)">Apa khabar?</button>
            <button class="quick-q" onclick="askQuestion(this.textContent)">Apa itu ayat?</button>
            <button class="quick-q" onclick="askQuestion(this.textContent)">Tolong ajar matematik</button>
            <button class="quick-q" onclick="askQuestion(this.textContent)">Apa itu fotosintesis?</button>
            <button class="quick-q" onclick="askQuestion(this.textContent)">Cerita tentang Malaysia</button>
          `;
        } else {
          qs.innerHTML = `
            <button class="quick-q" onclick="askQuestion(this.textContent)">How are you?</button>
            <button class="quick-q" onclick="askQuestion(this.textContent)">What is a sentence?</button>
            <button class="quick-q" onclick="askQuestion(this.textContent)">Teach me maths</button>
            <button class="quick-q" onclick="askQuestion(this.textContent)">What is photosynthesis?</button>
            <button class="quick-q" onclick="askQuestion(this.textContent)">Tell me about Malaysia</button>
          `;
        }
      }
      renderQuiz();
      updateHomeMarks();
      
      // Update quiz end screen if currently viewing it
      const quizScreen = document.getElementById('screen-quiz');
      if (quizScreen && quizScreen.classList.contains('active') && currentQ >= quizData.length) {
        showQuizEnd();
      }
    }

    // ======== CHAT ========
    function handleChatKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
    }

    async function sendChat() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (!msg) return;

      // 1. Add User Bubble to UI
      addBubble(msg, 'user');
      input.value = '';

      // 2. Push User Message to History
      geminiChatHistory.push({
        role: "user",
        parts: [{ text: msg }]
      });

      const API_KEY = "AIzaSyD3aFUMgxo0HGkdY0APNMgeZWFxeRiKtc0";
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: geminiChatHistory // We send the WHOLE history here
          })
        });

        if (response.status === 429) throw new Error("QUOTA_EXCEEDED");
        if (!response.ok) throw new Error("OFFLINE_OR_ERROR");

        const data = await response.json();
        const aiText = data.candidates[0].content.parts[0].text;

        // 3. Push Model Response to History (so it remembers for the next turn)
        geminiChatHistory.push({
          role: "model",
          parts: [{ text: aiText }]
        });

        addBubble(aiText, 'ai');

      } catch (error) {
        console.error("Chat Error:", error);

        // 4. Fallback to your local data.js responses if API fails
        const fallbacks = window.aiResponses?.[currentLang] || ["Maaf, Cikgu penat sikit. Jom cuba lagi nanti!"];
        const randomFallback = fallbacks[Math.floor(Math.random() * fallbacks.length)];

        addBubble(randomFallback + " (Offline Mode ğŸ¦)", 'ai');
      }
    }

    function askQuestion(q) {
      document.getElementById('chat-input').value = q;
      sendChat();
    }

    function addBubble(text, who) {
      const msgs = document.getElementById('chat-messages');
      const row = document.createElement('div');
      row.style.display = 'flex';
      if (who === 'ai') {
        row.className = 'bubble-row';
        row.innerHTML = `<div class="ai-avatar">ğŸ¦</div><div class="chat-bubble bubble-ai"><div class="bubble-sender">Cikgu Leo ğŸ¦</div>${text}</div>`;
      } else {
        row.innerHTML = `<div class="chat-bubble bubble-user" style="margin-left:auto">${text}</div>`;
      }
      msgs.appendChild(row);
      scrollChat();
    }

    function scrollChat() {
      const msgs = document.getElementById('chat-messages');
      msgs.scrollTop = msgs.scrollHeight;
    }

    // ======== QUIZ ========
    function initQuiz() {
      currentQ = 0; answered = false;
      quizSessionScore = 0; // Reset session score for new quiz
      renderQuiz();
    }

    function renderQuiz() {
      if (currentQ >= quizData.length) { showQuizEnd(); return; }
      const q = quizData[currentQ];
      const lang = currentLang;
      answered = false;
      document.getElementById('quiz-no').textContent = `${lang === 'bm' ? 'Soalan' : 'Question'} ${currentQ + 1} / ${quizData.length}`;
      document.getElementById('quiz-score').textContent = `â­ ${quizSessionScore} ${lang === 'bm' ? 'mata' : 'pts'}`;
      document.getElementById('quiz-progress').style.width = `${((currentQ + 1) / quizData.length) * 100}%`;
      document.getElementById('quiz-img').textContent = q.img;
      document.getElementById('quiz-img').className = `quiz-question-img ${q.imgBg}`;
      document.getElementById('quiz-question').textContent = q[lang] || q.bm;
      const opts = q.options[lang] || q.options.bm;
      document.getElementById('quiz-options').innerHTML = opts.map((o, i) => `<button class="quiz-option" onclick="selectAnswer(${i})">${o}</button>`).join('');
      document.getElementById('quiz-feedback').className = 'quiz-feedback';
      document.getElementById('btn-next').className = 'btn-next';
    }

    function selectAnswer(idx) {
      if (answered) return;
      answered = true;
      const q = quizData[currentQ];
      const opts = document.querySelectorAll('.quiz-option');
      opts.forEach(o => o.disabled = true);
      const feedback = document.getElementById('quiz-feedback');
      if (idx === q.correct) {
        opts[idx].classList.add('correct');
        quizSessionScore += 10; // Increment session score
        currentScore += 10; // Also increment account total
        saveProgress();
        feedback.textContent = currentLang === 'bm' ? 'ğŸ‰ Betul!' : 'ğŸ‰ Correct!';
        feedback.className = 'quiz-feedback show correct';
      } else {
        opts[idx].classList.add('wrong');
        opts[q.correct].classList.add('correct');
        feedback.textContent = currentLang === 'bm' ? 'ğŸ˜… Cuba lagi!' : 'ğŸ˜… Try again!';
        feedback.className = 'quiz-feedback show wrong';
      }
      document.getElementById('quiz-score').textContent = `â­ ${quizSessionScore} ${currentLang === 'bm' ? 'mata' : 'pts'}`;
      updateHomeMarks();
      document.getElementById('btn-next').className = 'btn-next show';
    }

    function nextQuestion() {
      currentQ++;
      if (currentQ >= quizData.length) { showQuizEnd(); } else { renderQuiz(); }
    }

    function showQuizEnd() {
      const lang = currentLang;
      // Display session score only (not total account score)
      const sessionMsg = lang === 'bm' 
        ? `ğŸ† Kamu dapat ${quizSessionScore} mata dalam cabaran ini!` 
        : `ğŸ† You got ${quizSessionScore} pts in this challenge!`;
      const totalMsg = lang === 'bm'
        ? `ğŸ“Š Jumlah keseluruhan: ${currentScore} mata`
        : `ğŸ“Š Total account: ${currentScore} pts`;
      
      document.getElementById('quiz-question').textContent = sessionMsg;
      document.getElementById('quiz-img').textContent = 'ğŸ†';
      document.getElementById('quiz-options').innerHTML = `
        <div style="grid-column:1/-1; text-align: center; margin: 15px 0; font-size: 14px; color: #666;">
          ${totalMsg}
        </div>
        <button class="quiz-option" style="grid-column:1/-1;background:var(--lime);color:var(--purple-dark)" onclick="initQuiz()">
          ${lang === 'bm' ? 'ğŸ”„ Main Semula' : 'ğŸ”„ Play Again'}
        </button>
      `;
    }

    // ======== TOAST & STATUS ========
    function showToast(msg) {
      const t = document.getElementById('toast');
      if (t) {
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      }
    }

    function updateStatus() {
      const dot = document.getElementById('status-dot');
      const sub = document.getElementById('sync-status');
      if (navigator.onLine) {
        dot?.classList.remove('offline');
        if (sub) sub.textContent = currentLang === 'bm' ? 'Dalam talian â€¢ Berhubung' : 'Online â€¢ Connected';
      } else {
        dot?.classList.add('offline');
        if (sub) sub.textContent = currentLang === 'bm' ? 'Luar talian â€¢ Data Lama' : 'Offline â€¢ Old Data';
      }
    }

    // ======== EXPOSE TO WINDOW ========
    window.setLang = setLang;
    window.showScreen = showScreen;
    window.goToHome = goToHome;
    window.chooseSubject = chooseSubject;
    window.chooseStandard = chooseStandard;
    window.showLessons = showLessons;
    window.openLesson = openLesson;
    window.saveLesson = saveLesson;
    window.renderFavourites = renderFavourites;
    window.goToFavLesson = goToFavLesson;
    window.handleChatKey = handleChatKey;
    window.sendChat = sendChat;
    window.askQuestion = askQuestion;
    window.initQuiz = initQuiz;
    window.selectAnswer = selectAnswer;
    window.nextQuestion = nextQuestion;

    // ======== INIT ========
    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
    updateStatus();

    // Service Worker only works on http/https
    if (['http:', 'https:'].includes(location.protocol) && 'serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(err => console.warn('SW failed:', err));
    } else if (location.protocol === 'file:') {
      console.log('Service Worker skipped (file:// protocol detected)');
    }

    renderFavourites();
    initQuiz();
    } catch (error) {
      console.error('ğŸš¨ Critical Error:', error);
      document.body.innerHTML = `
        <div style="padding: 20px; text-align: center; font-family: Arial;">
          <h1>âš ï¸ Oops! Loading Error</h1>
          <p>There's an issue loading the app. Please:</p>
          <ol style="text-align: left; max-width: 400px; margin: 20px auto;">
            <li>Check your internet connection</li>
            <li>Refresh the page (Ctrl+R or Cmd+R)</li>
            <li>Clear browser cache (Ctrl+Shift+Delete)</li>
            <li>Try a different browser</li>
          </ol>
          <p><strong>Error:</strong> ${error.message}</p>
          <button onclick="location.reload()" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">ğŸ”„ Reload Page</button>
        </div>
      `;
    }
  </script>
</body>

</html>